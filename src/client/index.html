<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Client</title>
</head>
<body>
    <div class="canvas-holder" style="background-color: gray;">
        <canvas width="600" height="300" id="StatisticCanva">
            
        </canvas>
    </div>

    <button id="StartListening">Start Listening</button>
    <button id="StopListening">Stop Listening</button>
    
    <label for="FetchChunkData">Keep updating</label>
    <input type="checkbox" name="" id="FetchChunkData">
    <!-- <button id="FetchChunkData">Fetch data</button> -->
    <script>
        const ListenButton = document.getElementById("StartListening");
        const StopListenButton = document.getElementById("StopListening");
        const FetchCheckbox = document.getElementById("FetchChunkData");
        ListenButton.onclick=start_listening;
        StopListenButton.onclick=stop_listening;

        const Canvas = document.getElementById("StatisticCanva");
        const intervalId = setInterval(() => {
            if (!FetchCheckbox.checked) {
                return;
            }
            fetch_chunk_data()
        }, 250); // Executes every 1 second


        function start_listening() {
            fetch("http://127.0.0.1:5000/listen", {
                method: 'GET',
                headers: {
                }
            }).then(
            response => {
                return response.json()
            }
            ).then(data => {console.log(data)}).catch(error => {
                console.error('Error fetching data:', error); 
            });
        }

        function stop_listening() {
            fetch("http://127.0.0.1:5000/stop-listening", {
                method: 'GET',
                headers: {

                }
            }).then(
                response => {
                    console.log(response)
                    return response.json()
                }
            ).then(data => {
                // console.log(data)
                parse_chunk_data(data.body)
            }).catch(error => {
                console.error('Error fetching data:', error); 
            });
        }

        function fetch_chunk_data() {
            fetch("http://127.0.0.1:5000/get-data", {
                method: 'GET',
                headers: {

                }
            }).then(
                response => {
                    console.log(response)
                    return response.json()
                }
            ).then(data => {
                // console.log(data)
                parse_chunk_data(data.body)

            }).catch(error => {
                console.error('Error fetching data:', error); 
            });
        }

        
        function parse_chunk_data(body) {
            context = Canvas.getContext("2d");
            pixel_size = 4

            Canvas.setAttribute("width", body.grid_size[0] * pixel_size);
            Canvas.setAttribute("height", body.grid_size[1] * pixel_size);
            context.clearRect(0, 0, Canvas.width, Canvas.height);

            chunk_data = body.chunk_data.chunks
            for (const row_key in chunk_data) {
                for (let idx = 0; idx < chunk_data[row_key].length; idx++) {
                    // console.log("Painting " + row_key + " " + idx)
                    value = chunk_data[row_key][idx];
                    if (value == 0) {
                        continue;
                    }
                    color = 'rgba(0, 0, 255, ' + value + ')'
                    drawDot(context, idx, row_key, color, pixel_size);
                }
            }
        }

        function drawDot(context, x, y, color, size = 1) {
            context.fillStyle = color;
            context.fillRect(x * size, y * size, size, size);
        }
    </script>
</body>
</html>