<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statski</title>
    <link rel="stylesheet" href="../style/main.css">
    <link rel="stylesheet" href="../style/components.css">
</head>
<body>
    <div class="titlebar">Statski</div>
    <div class="content">
        <div class="left-panel">
            <ul class="left-panel-options">
                <li class="left-panel-option"><a href="?">Some Option</a></li>
                <li class="left-panel-option"><a href="?">Some Option</a></li>
            </ul>
            <hr style="background-color: var(--color-clear-white); border-radius: var(--default-border-radius);">
            <button class="settings-button">Settings</button>
        </div>
        <div class="main-content" id="main-content">
            <div class="navbar">
                <ul class="navbar-items">
                    <li class="nav-item"><a href="?tab=mouse">Mouse</a></li>
                    <li class="nav-item"><a href="?tab=keyboard">Keyboard</a></li>
                </ul>
                <div class="navbar-right">
                    Profile
                </div>
            </div>
            <div class="statistic-preview">
                <canvas id="MouseHeatmap"></canvas>
            </div>
            <hr>
            <div class="control-panel">
                <ul class="control-buttons">
                    <li><button class="control-button cancel hidden" id="StopListening">Stop Listening</button></li>
                    <li><button class="control-button confirm" id="StartListening">Start Listening</button></li>
                    <li><label for="fetching">Fetch</label><input type="checkbox" name="fetching" id="FetchCheckbox" ></li>
                </ul>

                <button class="control-button" id="SaveFile">Save</button>
                <label id="StatusLabel">API Status: </label>                
            </div>
        </div>
    </div>
    <script src="../js/api_calls.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        const DEFAULT_FILE_PATH = "";
        let current_api_status = 0;

        const Canvas = document.getElementById("MouseHeatmap");
        const FetchCheckbox = document.getElementById("FetchCheckbox");
        const StatisticHolder = document.getElementById("main-content");
        const StatusLabel = document.getElementById("StatusLabel");

        let chunk_property = "times_hovered";

        let max_content_height = StatisticHolder.clientHeight / 2;
        
        let grid_height = 16;
        let pixel_size = 4;
        window.addEventListener('resize', function() {
            max_content_height = StatisticHolder.clientHeight / 2;
            pixel_size = max_content_height / grid_height
        });

        const FetchInterval = setInterval(() => {
            if (current_api_status != 3) {
                return;
            }

            if (!FetchCheckbox.checked) {
                return;
            }
            fetch_chunk_data(chunk_property).then(data => {
                grid_height = data.body.grid_size[1] 
                parse_chunk_data(data.body, Canvas, pixel_size);
            });
        }, 100);

        const StatusInterval = setInterval(() => {
            if (FetchCheckbox.checked) {
                return;
            }
            check_api_status().then(data => {
                current_api_status = data.status;
                StatusLabel.innerText = "API Status: " + current_api_status;
            });
            if (current_api_status == 3) {
                StartListeningButton.classList.add("hidden")
                StopListeningButton.classList.remove("hidden")
            } else {
                StartListeningButton.classList.remove("hidden")
                StopListeningButton.classList.add("hidden")
            }
        }, 250);

        const StartListeningButton = document.getElementById("StartListening");
        StartListeningButton.onclick = () => {
            start_listening().then(() => {
                FetchCheckbox.checked = true;
            })
        }
        const StopListeningButton = document.getElementById("StopListening");
        StopListeningButton.onclick = () => {
            stop_listening().then(data => {
                parse_chunk_data(data.body, Canvas, pixel_size)
                FetchCheckbox.checked = false;
            })
        }

        const SaveButton = document.getElementById("SaveFile");
        SaveButton.onclick = () => {
            save_file(DEFAULT_FILE_PATH)
        }
    </script>
</body>
</html>